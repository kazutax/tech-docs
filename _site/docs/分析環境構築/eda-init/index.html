<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"><link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"><style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li:not(:nth-child(1)) > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(1) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(2) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(1) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(1) > ul.nav-list { display: block; }</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-C5VBKLJGZR"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-C5VBKLJGZR'); </script> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico" type="image/x-icon"><title>ローカル分析環境の量産 | Data Tech Docs</title><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="ローカル分析環境の量産" /><meta property="og:locale" content="en_US" /><meta name="description" content="M1 mac の環境で、個人的に現状一番使いやすい分析環境を構築する手順メモ。M1 Macbook + Pyenv + Poetry + Jupyter Notebook で構成。" /><meta property="og:description" content="M1 mac の環境で、個人的に現状一番使いやすい分析環境を構築する手順メモ。M1 Macbook + Pyenv + Poetry + Jupyter Notebook で構成。" /><link rel="canonical" href="http://localhost:4000/docs/%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/eda-init/" /><meta property="og:url" content="http://localhost:4000/docs/%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/eda-init/" /><meta property="og:site_name" content="Data Tech Docs" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="ローカル分析環境の量産" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"M1 mac の環境で、個人的に現状一番使いやすい分析環境を構築する手順メモ。M1 Macbook + Pyenv + Poetry + Jupyter Notebook で構成。","headline":"ローカル分析環境の量産","url":"http://localhost:4000/docs/%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/eda-init/"}</script> <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.stemmer.support.min.js"></script> <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/tinyseg.js"></script> <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.ja.min.js"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> Data Tech Docs </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 分析環境構築 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/index-env" class="nav-list-link">分析環境構築</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/eda-init/" class="nav-list-link">ローカル分析環境の量産</a><li class="nav-list-item"><a href="/docs/%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/git-user/" class="nav-list-link">Git ユーザー登録</a><li class="nav-list-item"><a href="/docs/%E5%88%86%E6%9E%90%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89/iterm-settings/" class="nav-list-link">iTerm 環境設定</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 統計学（頻度論） category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/index-stats" class="nav-list-link">統計学（頻度論）</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/%E7%B5%B1%E8%A8%88%E5%AD%A6%EF%BC%88%E9%A0%BB%E5%BA%A6%E8%AB%96%EF%BC%89/plot_dist/" class="nav-list-link">有意水準と検出力</a><li class="nav-list-item"><a href="/docs/%E7%B5%B1%E8%A8%88%E5%AD%A6%EF%BC%88%E9%A0%BB%E5%BA%A6%E8%AB%96%EF%BC%89/sample_size/" class="nav-list-link">サンプルサイズ計算</a><li class="nav-list-item"><a href="/docs/%E7%B5%B1%E8%A8%88%E5%AD%A6%EF%BC%88%E9%A0%BB%E5%BA%A6%E8%AB%96%EF%BC%89/t_test_type/" class="nav-list-link">t検定の種類</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in ベイズ統計 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/index-bayesian" class="nav-list-link">ベイズ統計</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/%E3%83%99%E3%82%A4%E3%82%BA%E7%B5%B1%E8%A8%88/bayes-base/" class="nav-list-link">ベイズ推定のキホン</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in ネットワーク category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/index-network" class="nav-list-link">ネットワーク</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF/sample-network-child/" class="nav-list-link">ネットワーク 子ページサンプル</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in jekyll category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/index-jekyll" class="nav-list-link">jekyll</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/jekyll/latex-on-jekyll/" class="nav-list-link">Jekyll で Latex</a><li class="nav-list-item"><a href="/docs/jekyll/ja-search-jekyll/" class="nav-list-link">Jekyll で 日本語検索</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 英語 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/index-end" class="nav-list-link">英語</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in IT技術表現 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/%E8%8B%B1%E8%AA%9E/tech-eng/" class="nav-list-link">IT技術表現</a><ul class="nav-list"></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 日常表現 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/%E8%8B%B1%E8%AA%9E/daily-eng/" class="nav-list-link">日常表現</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/%E8%8B%B1%E8%AA%9E/second-to-none/" class="nav-list-link">Second To None</a></ul></ul></ul><ul class="nav-list"><li class="nav-list-item external"> <a href="https://www.linkedin.com/in/kazutak/" class="nav-list-link external" target="_blank" rel="noopener noreferrer" > Profile (LinkedIn) <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Data Tech Docs" aria-label="Search Data Tech Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/kazutax/tech-docs" class="site-button" > Data Tech Docs on GitHub </a></ul></nav></div><div class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/index-env">分析環境構築</a><li class="breadcrumb-nav-list-item"><span>ローカル分析環境の量産</span></ol></nav><div id="main-content" class="main-content"><main><h1 id="ローカル分析環境の量産"> <a href="#ローカル分析環境の量産" class="anchor-heading" aria-labelledby="ローカル分析環境の量産"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ローカル分析環境の量産</h1><p class="highlight"><strong>前提</strong><br /> M1 mac の環境で、個人的に現状一番使いやすい分析環境を構築する手順メモ。<br /> <strong>M1 Macbook</strong> + <strong>Pyenv</strong> + <strong>Poetry</strong> + <strong>Jupyter Notebook</strong> で構成。</p><h2 id="-概要"> <a href="#-概要" class="anchor-heading" aria-labelledby="-概要"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ■ 概要</h2><p>Python による分析環境構築のため，以下2種類のパッケージを使用する。</p><ul><li><strong>Pyenv</strong>: Python 仮想環境管理<li><strong>Poetry</strong>: パッケージ管理</ul><p>Anaconda は上記2つを1つにまとめたようなもので便利だったが、商用利用で有償となったので使うのやめた。 ← 参考：<a href="https://www.anaconda.com/blog/sustaining-our-stewardship-of-the-open-source-data-science-community">Sustaining our stewardship of the open-source data science community</a><br /> また、Poetry 単体では Python のバージョンは管理できないようなので Pyenv を併用する。</p><p>Poetry と Pyenv の初回インストール後、日常使っていて新たに仮想環境立てる場面でいろいろ忘れてることが多いので、備忘のためにまとめる。</p><h2 id="-poetry-のインストール初回のみ"> <a href="#-poetry-のインストール初回のみ" class="anchor-heading" aria-labelledby="-poetry-のインストール初回のみ"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ■ Poetry のインストール（初回のみ）</h2><p>参考：<a href="https://python-poetry.org/docs/">Poetry Docs</a></p><p>以下ターミナルで実行してダウンロード</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">curl <span class="nt">-sSL</span> https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py <span class="se">\ß</span>| python -</code></pre></figure><p>パスが通らないと思うので .zshrc ファイルを修正</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh"><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">/.poetry/bin"</span></code></pre></figure><p>バージョン確認ができればOK</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry <span class="nt">--version</span></code></pre></figure><h2 id="-pyenv-のインストール初回のみ"> <a href="#-pyenv-のインストール初回のみ" class="anchor-heading" aria-labelledby="-pyenv-のインストール初回のみ"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ■ pyenv のインストール（初回のみ）</h2><p>M1 Macbook システムに入っている標準の Python は ver.2.7（2021.11.27現在）</p><p>Python 環境は別途 M1 Mac に直接入れるか、仮想環境をたてて設定する（Python 3.x の bin ファイルをどこかに置いてパスを参照させる）必要がある。<br /> ネットでよく見かけるのは pyenv で環境を立ててその Python bin パスを Poetry に通すというやり方。（以下説明）</p><p>参考URL：https://github.com/pyenv/pyenv#basic-github-checkout</p><p>以下ターミナルで実行してダウンロード。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">git clone https://github.com/pyenv/pyenv.git ~/.pyenv
<span class="nb">cd</span> ~/.pyenv <span class="o">&amp;&amp;</span> src/configure <span class="o">&amp;&amp;</span> make <span class="nt">-C</span> src</code></pre></figure><p>パスが通らないと思うので .zprofile, .zshrc ファイルを修正</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh"><span class="nb">echo</span> <span class="s1">'export PYENV_ROOT="$HOME/.pyenv"'</span> <span class="o">&gt;&gt;</span> ~/.zprofile
<span class="nb">echo</span> <span class="s1">'export PATH="$PYENV_ROOT/bin:$PATH"'</span> <span class="o">&gt;&gt;</span> ~/.zprofile
<span class="nb">echo</span> <span class="s1">'eval "$(pyenv init --path)"'</span> <span class="o">&gt;&gt;</span> ~/.zprofile
<span class="nb">echo</span> <span class="s1">'eval "$(pyenv init -)"'</span> <span class="o">&gt;&gt;</span> ~/.zshrc</code></pre></figure><p>ターミナルを再起動して以下を実行し、バージョンが確認できればOK</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pyenv <span class="nt">--version</span></code></pre></figure><h2 id="-任意の仮想環境を構築量産手順"> <a href="#-任意の仮想環境を構築量産手順" class="anchor-heading" aria-labelledby="-任意の仮想環境を構築量産手順"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ■ 任意の仮想環境を構築（量産手順）</h2><p><code class="language-plaintext highlighter-rouge">pyenv --version</code> と <code class="language-plaintext highlighter-rouge">poetry --version</code> を実行して、設定したい環境にそれぞれ疎通を確認。</p><h3 id="pyenv-で必要な-python-version-をインストールする"> <a href="#pyenv-で必要な-python-version-をインストールする" class="anchor-heading" aria-labelledby="pyenv-で必要な-python-version-をインストールする"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> pyenv で必要な Python version をインストールする</h3><p>任意の Python バージョンを利用するためにインストールする。実行できるバージョンを確認するには、</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pyenv <span class="nb">install</span> <span class="nt">--list</span></code></pre></figure><p>で一覧を確認できる。その中から好きなバージョンを</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pyenv <span class="nb">install </span>3.9.9</code></pre></figure><p>でダウンロード、インストールする。</p><p>環境にはインストールされたが M1 Mac がターミナルで <code class="language-plaintext highlighter-rouge">python</code> と打った時に反応するのはシステム側の Python bin となってる。<br /> <code class="language-plaintext highlighter-rouge">python</code> と打つことでシステム側の Python を、<code class="language-plaintext highlighter-rouge">python3</code> と打つことで今回インストールした 3.9.9 を使えるようにするには、本来的には以下のコマンドで実現できるはずなのだが、、、</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pyenv global system 3.9.9</code></pre></figure><p>残念ながら、<strong>M1 Mac ではこれが反応しなそう</strong> だったので、設定する Poetry の環境ごとに以下を実行して対応する。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pyenv <span class="nb">local </span>3.9.9</code></pre></figure><p>そもそも Pyenv では global は全体設定、local は特定のディレクトリ内でのバージョン設定となっており、設定していれば local が優先される。<br /> （この設定は次の <strong>“Poetry env で Python version を変更する“</strong> で初手として実行する。）</p><h3 id="poetry-env-で-python-version-を変更する"> <a href="#poetry-env-で-python-version-を変更する" class="anchor-heading" aria-labelledby="poetry-env-で-python-version-を変更する"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Poetry env で Python version を変更する</h3><p>（もしまだ作業ディレクトリが存在しなければ、）任意の場所に Poetry の Python 実行環境のディレクトリをおいて移動し、初手として <code class="language-plaintext highlighter-rouge">pyenv local x.x.x</code> を実行する。</p><p>※自分がよく使う設定は <code class="language-plaintext highlighter-rouge">$HOME/Poetry/</code> の配下にプロジェクトを配置 ex. <code class="language-plaintext highlighter-rouge">/env20211127</code>（日付別に名前分け）</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh"><span class="nb">mkdir </span>env20211127
<span class="nb">cd </span>env20211127
pyenv <span class="nb">local </span>3.9.9</code></pre></figure><p>Pyenv 環境としては Python 3.9.9 が実行されるようになる。<br /> 以下のコマンドを実行すると、Pyenv として持っている Python のバージョン一覧が表示され、「＊」がついた環境で実行できていることを確認できる。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry init
poetry <span class="nb">install</span></code></pre></figure><p><code class="language-plaintext highlighter-rouge">poetry init</code> すると、対話式で質問が表示され、それらの質問に答えていくとプロジェクトの設定が完了し <code class="language-plaintext highlighter-rouge">pyproject.toml</code> という設定ファイルが作られる。</p><p>設定が完了したら、<code class="language-plaintext highlighter-rouge">poetry install</code> を行う。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">pyenv versions</code></pre></figure><p>次を実行して Poetry のバージョンを変更し、状態を確認する。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry <span class="nb">env </span>use 3.9.9
poetry <span class="nb">env </span>info</code></pre></figure><p>Python のバージョンが切り替わる。<br /> もし、pyenv でとってきてないバージョンを指定しようとするとエラーとなる。同一のバージョンが複数ある場合にはフルパスで Python を指定すれば良い。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry <span class="nb">env </span>use /fullpath/to/the/python/</code></pre></figure><p>※ pyenv の python の場所はどこ？ → /Users/kazutak/.pyenv/versions/3.9.9/bin/python3.9 とかにあるよ</p><p>※ 自分コピペ用</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry <span class="nb">env </span>use /Users/kazutak/.pyenv/versions/3.9.9/bin/python3.9</code></pre></figure><h3 id="jupyter-notebook-で-poetry-環境の-jupyter-kernel-を参照させる"> <a href="#jupyter-notebook-で-poetry-環境の-jupyter-kernel-を参照させる" class="anchor-heading" aria-labelledby="jupyter-notebook-で-poetry-環境の-jupyter-kernel-を参照させる"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Jupyter Notebook で poetry 環境の Jupyter kernel を参照させる</h3><p>分析環境に Jupyter Notebook をインストールする。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry add jupyter notebook</code></pre></figure><p>参考：<a href="https://gadgetlunatic.com/post/use-poetry-along-with-jupyter/">https://gadgetlunatic.com/post/use-poetry-along-with-jupyter/</a></p><p>このまま、<code class="language-plaintext highlighter-rouge">poetry run jupyter notebook</code> のコマンドから Jupyter Notebook を起動して、その内で実行したコードに Poetry でインストールしたモジュールをインポートしようとすると、<code class="language-plaintext highlighter-rouge">ModuleNotFoundError</code> を吐く。<br /> 原因は、システムにインストールされている Jupyter が使っている Python kernel からは Poetry プロジェクトの venv が参照できないため。</p><p>これを解決するために、Jupyter に Poetry が生成した venv のカーネルを追加する。<br /> はじめに ipykernel モジュールをプロジェクトに追加する。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry add <span class="nt">--dev</span> ipykernel</code></pre></figure><p><code class="language-plaintext highlighter-rouge">poetry shell</code> などで仮想環境に入ったのちに、次のコマンドを実行することで pyenv のカーネルを Jupyter に追加することができる。</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">ipython kernel <span class="nb">install</span> <span class="nt">--user</span> <span class="nt">--name</span><span class="o">=</span>your-project-name</code></pre></figure><p>Jupyter 上でさきほど追加したカーネルを指定して実行することで、問題なくインポートを含むコードを実行することができる。Jupyter で使えるカーネルの一覧の確認方法は以下：</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">jupyter kernelspec list</code></pre></figure><p>追加したカーネルの削除方法は以下：</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">jupyter kernelspec remove your-kernel-name</code></pre></figure><h2 id="-上記環境設定時の事件簿"> <a href="#-上記環境設定時の事件簿" class="anchor-heading" aria-labelledby="-上記環境設定時の事件簿"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ■ 上記環境設定時の事件簿</h2><h3 id="事件その1poery-管理のライブラリを-kernel-が参照しない問題解決済"> <a href="#事件その1poery-管理のライブラリを-kernel-が参照しない問題解決済" class="anchor-heading" aria-labelledby="事件その1poery-管理のライブラリを-kernel-が参照しない問題解決済"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 【事件その1】Poery 管理のライブラリを kernel が参照しない問題（解決済）</h3><p>普通に以下で Notebook を起動</p><figure class="highlight"><pre><code class="language-zsh" data-lang="zsh">poetry run jupyter notebook</code></pre></figure><p>順調に起動し、設定済みの kernel で Notebook を利用可能、、と思ったらライブラリの読み込みで <code class="language-plaintext highlighter-rouge">poetry add</code> したはずのライブラリ読み込みエラーなった。。</p><p><img src="/tech-docs/assets/images/post-imgs/env/lib-error.png" alt="lib-error" /> <br /> <code class="language-plaintext highlighter-rouge">sys.version</code>、 <code class="language-plaintext highlighter-rouge">sys.executable</code> を確認してみると、pyenv で設定している python 環境に kernel が接続されていないことがある。</p><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="n">sys</span>
<span class="nf">print</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">version</span><span class="p">)</span></code></pre></figure><p>実行すると、意図しない python 環境（system）を参照してしまっているはず。</p><p>※ <code class="language-plaintext highlighter-rouge">poetry env info</code> で設定している仮想環境の python は期待挙動 <br /> <img src="/tech-docs/assets/images/post-imgs/env/poetry-env-info.png" alt="poetry-env-info" /></p><p class="highlight"><strong>【解決策】</strong>2021/12/31<br /> <code class="language-plaintext highlighter-rouge">poetry shell</code> で仮想環境をアクティブ化してから kernel を起動しないとダメ。</p><h3 id="事件その2scipysklearn-が入らない問題解決済"> <a href="#事件その2scipysklearn-が入らない問題解決済" class="anchor-heading" aria-labelledby="事件その2scipysklearn-が入らない問題解決済"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 【事件その2】scipy・sklearn が入らない問題（解決済）</h3><p>なぜか <code class="language-plaintext highlighter-rouge">scipy</code> が入らない。。もともと <code class="language-plaintext highlighter-rouge">scikit-learn</code> を入れて使いたかったが、依存関係を制御する.tomlファイルをいじっても解決せず。<br /> 仕方ないから <code class="language-plaintext highlighter-rouge">miniforge</code> 環境を現時点の標準とする。（M1 じゃない Macbook Pro には同じ操作で問題なくインストールできた。偉い人が解決するまでは M1 では <code class="language-plaintext highlighter-rouge">miniforge</code> ユーザーとして頑張る）</p><p>2021/10/24 → <code class="language-plaintext highlighter-rouge">pyenv</code> のバージョンうまくいじると入ったりするかも？再現確認までできてない</p><p class="highlight"><strong>【解決策】</strong>2023/4/22<br /> <code class="language-plaintext highlighter-rouge">pyproject.toml</code> で <code class="language-plaintext highlighter-rouge">python = "&gt;=3.9, &lt;3.13"</code> に指定して <code class="language-plaintext highlighter-rouge">poetry update</code> したら <code class="language-plaintext highlighter-rouge">poetry add scipy</code> が問題なく実行できた！</p><h2 id="-参考url"> <a href="#-参考url" class="anchor-heading" aria-labelledby="-参考url"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ■ 参考URL：</h2><ul><li><a href="https://qiita.com/thesugar/items/1cd91eb3f5de7d390490">https://qiita.com/thesugar/items/1cd91eb3f5de7d390490</a><li><a href="https://blog.mktia.com/pyenv-and-poetry-on-mac-m1/">https://blog.mktia.com/pyenv-and-poetry-on-mac-m1/</a></ul></main></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
